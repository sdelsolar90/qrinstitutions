<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assignment Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-6xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-5">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Assignment Manager</h1>
          <p class="text-sm text-gray-500 mt-1">Teacher + Course assignment flow with search and clear context</p>
        </div>
        <div class="flex items-center gap-2">
          <a id="openTeacherProfileBtn" href="#" class="hidden bg-white text-blue-700 border border-blue-300 px-4 py-2 rounded-lg hover:bg-blue-50 transition-colors">
            Open Teacher Profile
          </a>
          <button id="backBtn" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition-colors">
            Back
          </button>
        </div>
      </div>

      <div id="message" class="text-sm mb-4"></div>

      <div class="mb-5 p-4 border border-gray-200 rounded-lg bg-gray-50">
        <label for="institutionSelect" class="block text-sm font-medium text-gray-700 mb-1">Institution Context</label>
        <select id="institutionSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
        <p id="institutionHelp" class="text-xs text-gray-500 mt-1"></p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
        <div class="p-4 border border-gray-200 rounded-lg">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">1) Select Teacher</h2>
          <input id="teacherSearchInput" type="text" placeholder="Search teacher by name or email"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-2">
          <select id="teacherSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
          <p id="teacherMeta" class="text-xs text-gray-500 mt-2">No teacher selected.</p>
        </div>

        <div class="p-4 border border-gray-200 rounded-lg">
          <h2 class="text-lg font-semibold text-gray-800 mb-3">2) Select Course</h2>
          <select id="courseProgramFilterSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-2"></select>
          <input id="courseSearchInput" type="text" placeholder="Search course by code, name or section"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-2">
          <select id="courseSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
          <p id="courseMeta" class="text-xs text-gray-500 mt-2">No course selected.</p>
        </div>
      </div>

      <div class="mb-5 flex items-center gap-2">
        <button id="assignBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
          Assign Course to Teacher
        </button>
        <button id="reloadBtn" class="bg-white text-gray-800 border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
          Reload Data
        </button>
        <span id="readOnlyBadge" class="hidden text-xs px-3 py-1 rounded-full bg-amber-100 text-amber-800">Read only role</span>
      </div>

      <div class="mb-3 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800">Current Assignments for Teacher</h2>
        <span id="assignedCountBadge" class="text-xs px-3 py-1 rounded-full bg-blue-100 text-blue-800">0 assignments</span>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300 text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 border text-left">Program</th>
              <th class="px-3 py-2 border text-left">Version</th>
              <th class="px-3 py-2 border text-left">Code</th>
              <th class="px-3 py-2 border text-left">Course</th>
              <th class="px-3 py-2 border text-left">Section</th>
              <th class="px-3 py-2 border text-left">Schedule</th>
              <th class="px-3 py-2 border text-left">Status</th>
            </tr>
          </thead>
          <tbody id="assignmentTable" class="bg-white"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = (window.location.origin && window.location.origin !== "null")
      ? window.location.origin
      : "http://127.0.0.1:5001";
    const ALL_INSTITUTIONS_VALUE = "__all__";

    const authToken = localStorage.getItem("authToken");
    const authUserRaw = localStorage.getItem("authUser");
    const authUser = authUserRaw ? JSON.parse(authUserRaw) : null;
    const allowedRoles = ["superadmin", "admin", "institution_admin", "institution_user"];
    if (!authToken || !authUser || !allowedRoles.includes(authUser.role)) {
      window.location.href = "login.html";
    }

    const isGlobalAdmin = authUser?.role === "superadmin" || authUser?.role === "admin";
    const canManageAcademic = isGlobalAdmin || authUser?.role === "institution_admin";

    const params = new URLSearchParams(window.location.search);
    const requestedInstitutionId = String(params.get("institutionId") || "").trim();
    const requestedReturnInstitutionId = String(params.get("returnInstitutionId") || "").trim();
    const requestedTeacherId = String(params.get("teacherId") || "").trim();
    const requestedReturnTo = String(params.get("returnTo") || "").trim();
    const normalizedRequestedInstitutionId =
      requestedInstitutionId && requestedInstitutionId !== ALL_INSTITUTIONS_VALUE
        ? requestedInstitutionId
        : "";

    let selectedInstitutionId = normalizedRequestedInstitutionId || localStorage.getItem("activeInstitutionId") || authUser?.institutionId || "";
    let returnInstitutionId =
      requestedReturnInstitutionId ||
      (String(localStorage.getItem("activeInstitutionScope") || "").trim() === "all" && isGlobalAdmin
        ? ALL_INSTITUTIONS_VALUE
        : normalizedRequestedInstitutionId);
    const returnToPath = requestedReturnTo;
    let selectedTeacherId = requestedTeacherId || "";
    let selectedCourseId = "";
    let teacherRows = [];
    let courseRows = [];
    let institutionRows = [];
    let teacherQuery = "";
    let courseQuery = "";
    let selectedProgram = "";

    axios.defaults.headers.common.Authorization = "Bearer " + authToken;
    axios.interceptors.request.use((config) => {
      const storedInstitutionId = localStorage.getItem("activeInstitutionId") || "";
      const scopedInstitutionId = isGlobalAdmin
        ? (selectedInstitutionId || storedInstitutionId)
        : (selectedInstitutionId || storedInstitutionId || authUser?.institutionId || "");

      if (scopedInstitutionId) {
        config.headers["X-Institution-Id"] = scopedInstitutionId;
      } else if (config.headers && Object.prototype.hasOwnProperty.call(config.headers, "X-Institution-Id")) {
        delete config.headers["X-Institution-Id"];
      }
      return config;
    });

    axios.interceptors.response.use(
      (response) => response,
      (error) => {
        const status = error?.response?.status;
        if (status === 401 || status === 403) {
          localStorage.removeItem("authToken");
          localStorage.removeItem("authUser");
          localStorage.removeItem("adminToken");
          localStorage.removeItem("activeInstitutionId");
          localStorage.removeItem("activeInstitutionName");
          localStorage.removeItem("activeInstitutionScope");
          window.location.href = "login.html";
        }
        return Promise.reject(error);
      }
    );

    function setMessage(message, type = "info") {
      const el = document.getElementById("message");
      if (!el) return;
      el.textContent = message || "";
      el.className = "text-sm mb-4";
      if (type === "error") el.classList.add("text-red-600");
      if (type === "success") el.classList.add("text-green-600");
      if (type === "info") el.classList.add("text-gray-600");
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    function formatCourseDays(daysOfWeek) {
      if (!Array.isArray(daysOfWeek) || !daysOfWeek.length) return "";
      const dayLabels = {
        MON: "Mon",
        TUE: "Tue",
        WED: "Wed",
        THU: "Thu",
        FRI: "Fri",
        SAT: "Sat",
        SUN: "Sun"
      };
      return daysOfWeek.map((day) => dayLabels[day] || day).join("/");
    }

    function formatCourseSchedule(course) {
      const days = formatCourseDays(course?.daysOfWeek || []);
      if (!days || !course?.startTime || !course?.endTime) return "Not configured";
      return days + " " + course.startTime + "-" + course.endTime;
    }

    function updateTeacherProfileLink() {
      const btn = document.getElementById("openTeacherProfileBtn");
      if (!btn) return;
      if (!selectedTeacherId) {
        btn.classList.add("hidden");
        btn.removeAttribute("href");
        return;
      }

      btn.classList.remove("hidden");
      const pageParams = new URLSearchParams();
      pageParams.set("userId", selectedTeacherId);
      if (selectedInstitutionId) pageParams.set("institutionId", selectedInstitutionId);
      if (returnInstitutionId || selectedInstitutionId) {
        pageParams.set("returnInstitutionId", returnInstitutionId || selectedInstitutionId);
      }
      const currentReturnTo = window.location.pathname + window.location.search;
      pageParams.set("returnTo", currentReturnTo);
      btn.href = "staff-view.html?" + pageParams.toString();
    }

    function renderInstitutionOptions() {
      const select = document.getElementById("institutionSelect");
      const help = document.getElementById("institutionHelp");
      if (!select || !help) return;

      if (isGlobalAdmin) {
        const options = ['<option value="">Select an institution</option>'];
        options.push(
          ...institutionRows.map((inst) => '<option value="' + inst.id + '">' + escapeHtml(inst.name || "-") + ' (' + escapeHtml(inst.code || "-") + ')</option>')
        );
        select.innerHTML = options.join("");
        select.disabled = false;
        if (selectedInstitutionId && institutionRows.some((inst) => inst.id === selectedInstitutionId)) {
          select.value = selectedInstitutionId;
          help.textContent = "Platform scope: choose institution before assigning.";
        } else {
          select.value = "";
          help.textContent = "Select institution to continue.";
        }
        return;
      }

      const ownId = String(authUser?.institutionId || selectedInstitutionId || "").trim();
      const ownName = String(authUser?.institution?.name || localStorage.getItem("activeInstitutionName") || "My Institution");
      select.innerHTML = '<option value="' + ownId + '">' + escapeHtml(ownName) + "</option>";
      select.value = ownId;
      select.disabled = true;
      selectedInstitutionId = ownId;
      help.textContent = "Institution-scoped role.";
    }

    function renderTeacherOptions() {
      const select = document.getElementById("teacherSelect");
      const meta = document.getElementById("teacherMeta");
      if (!select || !meta) return;

      if (!teacherRows.length) {
        select.innerHTML = '<option value="">No teachers found</option>';
        select.disabled = true;
        selectedTeacherId = "";
        meta.textContent = "No teacher selected.";
        updateTeacherProfileLink();
        return;
      }

      select.disabled = false;
      select.innerHTML = teacherRows
        .map((teacher) => '<option value="' + teacher.id + '">' + escapeHtml(teacher.name || "-") + " (" + escapeHtml(teacher.email || "-") + ")</option>")
        .join("");

      if (!teacherRows.some((teacher) => teacher.id === selectedTeacherId)) {
        selectedTeacherId = teacherRows[0].id;
      }
      select.value = selectedTeacherId;

      const current = teacherRows.find((teacher) => teacher.id === selectedTeacherId);
      meta.textContent = current
        ? "Selected: " + (current.name || "-") + " | " + (current.isActive ? "ACTIVE" : "INACTIVE")
        : "No teacher selected.";
      updateTeacherProfileLink();
    }

    function renderProgramOptions(programRows) {
      const select = document.getElementById("courseProgramFilterSelect");
      if (!select) return;

      const options = ['<option value="">All programs</option>'];
      (Array.isArray(programRows) ? programRows : []).forEach((row) => {
        const label = String(row?.program || "General");
        const total = Number(row?.totalCourses || 0);
        options.push('<option value="' + escapeHtml(label) + '">' + escapeHtml(label + " (" + total + ")") + "</option>");
      });
      select.innerHTML = options.join("");
      if (Array.from(select.options).some((option) => option.value === selectedProgram)) {
        select.value = selectedProgram;
      } else {
        selectedProgram = "";
      }
    }

    function renderCourseOptions() {
      const select = document.getElementById("courseSelect");
      const meta = document.getElementById("courseMeta");
      if (!select || !meta) return;

      if (!courseRows.length) {
        select.innerHTML = '<option value="">No courses found</option>';
        select.disabled = true;
        selectedCourseId = "";
        meta.textContent = "No course selected.";
        return;
      }

      select.disabled = false;
      select.innerHTML = courseRows
        .map((course) => {
          const label = "[" + (course.program || "General") + " v" + (course.programVersion || "1") + "] " +
            (course.code || "-") + " - " + (course.name || "-") + " (Section " + (course.section || "-") + ")";
          return '<option value="' + course.id + '">' + escapeHtml(label) + "</option>";
        })
        .join("");

      if (!courseRows.some((course) => course.id === selectedCourseId)) {
        selectedCourseId = courseRows[0].id;
      }
      select.value = selectedCourseId;

      const current = courseRows.find((course) => course.id === selectedCourseId);
      meta.textContent = current ? "Schedule: " + formatCourseSchedule(current) : "No course selected.";
    }

    function renderAssignments(rows) {
      const table = document.getElementById("assignmentTable");
      const badge = document.getElementById("assignedCountBadge");
      if (!table || !badge) return;

      const list = Array.isArray(rows) ? rows : [];
      badge.textContent = list.length + " assignments";

      if (!list.length) {
        table.innerHTML = '<tr><td colspan="7" class="px-3 py-2 border text-center text-gray-500">No assignments found</td></tr>';
        return;
      }

      table.innerHTML = list.map((assignment) => {
        const course = assignment?.course || {};
        return `
          <tr>
            <td class="px-3 py-2 border">${escapeHtml(course.program || "General")}</td>
            <td class="px-3 py-2 border">${escapeHtml(course.programVersion || "1")}</td>
            <td class="px-3 py-2 border">${escapeHtml(course.code || "-")}</td>
            <td class="px-3 py-2 border">${escapeHtml(course.name || "-")}</td>
            <td class="px-3 py-2 border">${escapeHtml(course.section || "-")}</td>
            <td class="px-3 py-2 border">${escapeHtml(formatCourseSchedule(course))}</td>
            <td class="px-3 py-2 border">${assignment?.isActive ? "ACTIVE" : "INACTIVE"}</td>
          </tr>
        `;
      }).join("");
    }

    function setContextEnabled(enabled) {
      const ids = [
        "teacherSearchInput",
        "teacherSelect",
        "courseProgramFilterSelect",
        "courseSearchInput",
        "courseSelect",
        "assignBtn",
        "reloadBtn"
      ];
      ids.forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (id === "assignBtn" && !canManageAcademic) {
          el.disabled = true;
          return;
        }
        el.disabled = !enabled;
      });

      const readOnlyBadge = document.getElementById("readOnlyBadge");
      if (readOnlyBadge) {
        readOnlyBadge.classList.toggle("hidden", canManageAcademic);
      }
    }

    async function loadInstitutions() {
      if (!isGlobalAdmin) {
        renderInstitutionOptions();
        return;
      }
      const response = await axios.get(API_BASE + "/api/auth/institutions");
      institutionRows = response?.data?.data || [];
      renderInstitutionOptions();
    }

    async function loadTeachers() {
      if (!selectedInstitutionId) {
        teacherRows = [];
        renderTeacherOptions();
        renderAssignments([]);
        return;
      }
      const response = await axios.get(API_BASE + "/api/academic/teachers", {
        params: { q: teacherQuery, active: "true", page: 1, limit: 300 }
      });
      teacherRows = response?.data?.data || [];
      renderTeacherOptions();
    }

    async function loadPrograms() {
      if (!selectedInstitutionId) {
        renderProgramOptions([]);
        return;
      }
      const response = await axios.get(API_BASE + "/api/academic/programs", {
        params: { active: "true" }
      });
      renderProgramOptions(response?.data?.data || []);
    }

    async function loadCourses() {
      if (!selectedInstitutionId) {
        courseRows = [];
        renderCourseOptions();
        return;
      }
      const response = await axios.get(API_BASE + "/api/academic/courses", {
        params: {
          q: courseQuery,
          program: selectedProgram,
          active: "true",
          page: 1,
          limit: 300
        }
      });
      courseRows = response?.data?.data || [];
      renderCourseOptions();
    }

    async function loadAssignmentsForTeacher() {
      if (!selectedInstitutionId || !selectedTeacherId) {
        renderAssignments([]);
        return;
      }
      const response = await axios.get(API_BASE + "/api/academic/assignments", {
        params: { teacherId: selectedTeacherId, active: "true", page: 1, limit: 300 }
      });
      renderAssignments(response?.data?.data || []);
    }

    async function reloadAll() {
      if (!selectedInstitutionId) {
        setContextEnabled(false);
        setMessage("Select an institution first.", "info");
        teacherRows = [];
        courseRows = [];
        renderTeacherOptions();
        renderProgramOptions([]);
        renderCourseOptions();
        renderAssignments([]);
        return;
      }

      setContextEnabled(true);
      await loadPrograms();
      await loadTeachers();
      await loadCourses();
      await loadAssignmentsForTeacher();
      setMessage("Assignment data loaded.", "info");
    }

    async function assignTeacherToCourse() {
      if (!canManageAcademic) {
        setMessage("Read-only role: cannot create assignments.", "error");
        return;
      }
      if (!selectedInstitutionId) {
        setMessage("Select an institution first.", "error");
        return;
      }

      const teacherSelect = document.getElementById("teacherSelect");
      const courseSelect = document.getElementById("courseSelect");
      const teacherId = String(teacherSelect?.value || selectedTeacherId || "").trim();
      const courseId = String(courseSelect?.value || selectedCourseId || "").trim();

      if (!teacherId || !courseId) {
        setMessage("Select one teacher and one course.", "error");
        return;
      }

      await axios.post(API_BASE + "/api/academic/assignments", { teacherId, courseId });
      selectedTeacherId = teacherId;
      selectedCourseId = courseId;
      setMessage("Assignment saved.", "success");
      await loadAssignmentsForTeacher();
    }

    function canNavigateBackInApp() {
      return window.history.length > 1;
    }

    function goToReturnToPath() {
      if (!returnToPath) return false;
      try {
        const targetUrl = new URL(returnToPath, window.location.origin);
        if (targetUrl.origin !== window.location.origin) return false;
        window.location.href = targetUrl.pathname + targetUrl.search + targetUrl.hash;
        return true;
      } catch (error) {
        return false;
      }
    }

    function goBack({ preferHistory = true } = {}) {
      if (preferHistory && canNavigateBackInApp()) {
        window.history.back();
        return;
      }
      if (goToReturnToPath()) {
        return;
      }
      const targetInstitutionId = returnInstitutionId || selectedInstitutionId;
      const suffix = targetInstitutionId ? "?institutionId=" + encodeURIComponent(targetInstitutionId) : "";
      window.location.href = "admin-dashboard.html" + suffix;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const teacherSearchInput = document.getElementById("teacherSearchInput");
      const courseSearchInput = document.getElementById("courseSearchInput");
      const teacherSelect = document.getElementById("teacherSelect");
      const courseSelect = document.getElementById("courseSelect");
      const courseProgramFilterSelect = document.getElementById("courseProgramFilterSelect");
      const institutionSelect = document.getElementById("institutionSelect");
      const assignBtn = document.getElementById("assignBtn");
      const reloadBtn = document.getElementById("reloadBtn");
      const backBtn = document.getElementById("backBtn");

      const debouncedTeacherSearch = debounce(async () => {
        teacherQuery = String(teacherSearchInput?.value || "").trim();
        try {
          await loadTeachers();
          await loadAssignmentsForTeacher();
        } catch (error) {
          setMessage(error.response?.data?.message || "Failed to search teachers.", "error");
        }
      }, 250);

      const debouncedCourseSearch = debounce(async () => {
        courseQuery = String(courseSearchInput?.value || "").trim();
        try {
          await loadCourses();
        } catch (error) {
          setMessage(error.response?.data?.message || "Failed to search courses.", "error");
        }
      }, 250);

      if (teacherSearchInput) teacherSearchInput.addEventListener("input", debouncedTeacherSearch);
      if (courseSearchInput) courseSearchInput.addEventListener("input", debouncedCourseSearch);

      if (teacherSelect) {
        teacherSelect.addEventListener("change", async () => {
          selectedTeacherId = String(teacherSelect.value || "").trim();
          updateTeacherProfileLink();
          try {
            await loadAssignmentsForTeacher();
          } catch (error) {
            setMessage(error.response?.data?.message || "Failed to load assignments.", "error");
          }
        });
      }

      if (courseSelect) {
        courseSelect.addEventListener("change", () => {
          selectedCourseId = String(courseSelect.value || "").trim();
          renderCourseOptions();
        });
      }

      if (courseProgramFilterSelect) {
        courseProgramFilterSelect.addEventListener("change", async () => {
          selectedProgram = String(courseProgramFilterSelect.value || "").trim();
          try {
            await loadCourses();
          } catch (error) {
            setMessage(error.response?.data?.message || "Failed to filter courses.", "error");
          }
        });
      }

      if (institutionSelect) {
        institutionSelect.addEventListener("change", async () => {
          selectedInstitutionId = String(institutionSelect.value || "").trim();
          selectedTeacherId = "";
          selectedCourseId = "";
          if (selectedInstitutionId) {
            localStorage.setItem("activeInstitutionId", selectedInstitutionId);
            const institution = institutionRows.find((row) => row.id === selectedInstitutionId);
            if (institution?.name) localStorage.setItem("activeInstitutionName", institution.name);
          }
          updateTeacherProfileLink();
          try {
            await reloadAll();
          } catch (error) {
            setMessage(error.response?.data?.message || "Failed to load institution data.", "error");
          }
        });
      }

      if (assignBtn) {
        assignBtn.addEventListener("click", async () => {
          try {
            await assignTeacherToCourse();
          } catch (error) {
            setMessage(error.response?.data?.message || "Failed to assign course.", "error");
          }
        });
      }

      if (reloadBtn) {
        reloadBtn.addEventListener("click", async () => {
          try {
            await reloadAll();
          } catch (error) {
            setMessage(error.response?.data?.message || "Failed to reload data.", "error");
          }
        });
      }

      if (backBtn) {
        backBtn.addEventListener("click", () => goBack({ preferHistory: true }));
      }

      try {
        await loadInstitutions();
        await reloadAll();
      } catch (error) {
        setMessage(error.response?.data?.message || "Failed to initialize assignment manager.", "error");
      }
    });
  </script>
</body>
</html>
