<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-5xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-5">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Staff Profile</h1>
          <p class="text-sm text-gray-500 mt-1">User details and assigned courses</p>
        </div>
        <div class="flex items-center gap-2">
          <a id="editBtn" href="#" class="hidden bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            Edit User
          </a>
          <button id="backBtn" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition-colors">
            Back
          </button>
        </div>
      </div>

      <div id="message" class="text-sm mb-4"></div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
          <p class="text-xs uppercase tracking-wide text-gray-500">Name</p>
          <p id="userName" class="text-lg font-semibold text-gray-900">-</p>
        </div>
        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
          <p class="text-xs uppercase tracking-wide text-gray-500">Email</p>
          <p id="userEmail" class="text-lg font-semibold text-gray-900">-</p>
        </div>
        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
          <p class="text-xs uppercase tracking-wide text-gray-500">Role</p>
          <p id="userRole" class="text-lg font-semibold text-gray-900">-</p>
        </div>
        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
          <p class="text-xs uppercase tracking-wide text-gray-500">Status</p>
          <p id="userStatus" class="text-lg font-semibold text-gray-900">-</p>
        </div>
        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
          <p class="text-xs uppercase tracking-wide text-gray-500">Institution</p>
          <p id="userInstitution" class="text-lg font-semibold text-gray-900">-</p>
        </div>
        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
          <p class="text-xs uppercase tracking-wide text-gray-500">Last Login</p>
          <p id="userLastLogin" class="text-lg font-semibold text-gray-900">-</p>
        </div>
      </div>

      <div class="mb-3 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800">Assigned Courses</h2>
        <span id="assignedCountBadge" class="text-xs px-3 py-1 rounded-full bg-blue-100 text-blue-800">0 courses</span>
      </div>

      <div id="assignedHint" class="text-sm text-gray-600 mb-3"></div>

      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-300 text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-3 py-2 border text-left">Program</th>
              <th class="px-3 py-2 border text-left">Version</th>
              <th class="px-3 py-2 border text-left">Code</th>
              <th class="px-3 py-2 border text-left">Name</th>
              <th class="px-3 py-2 border text-left">Section</th>
              <th class="px-3 py-2 border text-left">Schedule</th>
              <th class="px-3 py-2 border text-left">Status</th>
            </tr>
          </thead>
          <tbody id="assignedCoursesTable" class="bg-white"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = (window.location.origin && window.location.origin !== "null")
      ? window.location.origin
      : "http://127.0.0.1:5001";

    const authToken = localStorage.getItem("authToken");
    const authUserRaw = localStorage.getItem("authUser");
    const authUser = authUserRaw ? JSON.parse(authUserRaw) : null;
    const allowedRoles = ["superadmin", "admin", "institution_admin", "institution_user"];

    if (!authToken || !authUser || !allowedRoles.includes(authUser.role)) {
      window.location.href = "login.html";
    }

    const isGlobalAdmin = authUser?.role === "superadmin" || authUser?.role === "admin";
    const canManageStaff = isGlobalAdmin || authUser?.role === "institution_admin";
    const ALL_INSTITUTIONS_VALUE = "__all__";

    const params = new URLSearchParams(window.location.search);
    const userId = String(params.get("userId") || "").trim();
    const requestedInstitutionId = String(params.get("institutionId") || "").trim();
    const requestedReturnInstitutionId = String(params.get("returnInstitutionId") || "").trim();
    const requestedReturnTo = String(params.get("returnTo") || "").trim();
    const normalizedRequestedInstitutionId =
      requestedInstitutionId && requestedInstitutionId !== ALL_INSTITUTIONS_VALUE
        ? requestedInstitutionId
        : "";

    let selectedInstitutionId = normalizedRequestedInstitutionId || localStorage.getItem("activeInstitutionId") || authUser?.institutionId || "";
    let returnInstitutionId =
      requestedReturnInstitutionId ||
      (String(localStorage.getItem("activeInstitutionScope") || "").trim() === "all" && isGlobalAdmin
        ? ALL_INSTITUTIONS_VALUE
        : normalizedRequestedInstitutionId);
    const returnToPath = requestedReturnTo;
    let currentUser = null;

    axios.defaults.headers.common.Authorization = "Bearer " + authToken;
    axios.interceptors.request.use((config) => {
      const storedInstitutionId = localStorage.getItem("activeInstitutionId") || "";
      const scopedInstitutionId = isGlobalAdmin
        ? (selectedInstitutionId || storedInstitutionId)
        : (selectedInstitutionId || storedInstitutionId || authUser?.institutionId || "");

      if (scopedInstitutionId) {
        config.headers["X-Institution-Id"] = scopedInstitutionId;
      } else if (config.headers && Object.prototype.hasOwnProperty.call(config.headers, "X-Institution-Id")) {
        delete config.headers["X-Institution-Id"];
      }
      return config;
    });

    axios.interceptors.response.use(
      (response) => response,
      (error) => {
        const status = error?.response?.status;
        if (status === 401 || status === 403) {
          localStorage.removeItem("authToken");
          localStorage.removeItem("authUser");
          localStorage.removeItem("adminToken");
          localStorage.removeItem("activeInstitutionId");
          localStorage.removeItem("activeInstitutionName");
          localStorage.removeItem("activeInstitutionScope");
          window.location.href = "login.html";
        }
        return Promise.reject(error);
      }
    );

    function setMessage(message, type = "info") {
      const el = document.getElementById("message");
      if (!el) return;
      el.textContent = message || "";
      el.className = "text-sm mb-4";
      if (type === "error") el.classList.add("text-red-600");
      if (type === "success") el.classList.add("text-green-600");
      if (type === "info") el.classList.add("text-gray-600");
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function formatRoleLabel(role) {
      const value = String(role || "").trim().toLowerCase();
      if (value === "superadmin") return "Superadmin";
      if (value === "admin") return "Admin (Platform)";
      if (value === "institution_admin") return "Institution Admin";
      if (value === "institution_user") return "Institution User (Read Only)";
      if (value === "teacher") return "Teacher";
      return role || "-";
    }

    function formatDateTime(value) {
      if (!value) return "-";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "-";
      return date.toLocaleString();
    }

    function formatCourseDays(daysOfWeek) {
      if (!Array.isArray(daysOfWeek) || !daysOfWeek.length) return "";
      const dayLabels = {
        MON: "Mon",
        TUE: "Tue",
        WED: "Wed",
        THU: "Thu",
        FRI: "Fri",
        SAT: "Sat",
        SUN: "Sun"
      };
      return daysOfWeek.map((day) => dayLabels[day] || day).join("/");
    }

    function formatCourseSchedule(course) {
      const days = formatCourseDays(course?.daysOfWeek || []);
      if (!days || !course?.startTime || !course?.endTime) {
        return "Not configured";
      }
      return days + " " + course.startTime + "-" + course.endTime;
    }

    function applyInstitutionContext(institutionId, institutionName = "") {
      selectedInstitutionId = String(institutionId || "").trim();
      if (!selectedInstitutionId) return;
      localStorage.setItem("activeInstitutionId", selectedInstitutionId);
      if (institutionName) {
        localStorage.setItem("activeInstitutionName", institutionName);
      }
    }

    function buildStaffEditorUrl(userIdValue, institutionIdValue = "", returnInstitutionIdValue = "", returnToValue = "") {
      const pageParams = new URLSearchParams();
      pageParams.set("mode", "edit");
      if (userIdValue) pageParams.set("userId", String(userIdValue));
      if (institutionIdValue) pageParams.set("institutionId", String(institutionIdValue));
      if (returnInstitutionIdValue) pageParams.set("returnInstitutionId", String(returnInstitutionIdValue));
      if (returnToValue) pageParams.set("returnTo", String(returnToValue));
      return "staff-editor.html?" + pageParams.toString();
    }

    function canNavigateBackInApp() {
      return window.history.length > 1;
    }

    function goToReturnToPath() {
      if (!returnToPath) return false;
      try {
        const targetUrl = new URL(returnToPath, window.location.origin);
        if (targetUrl.origin !== window.location.origin) return false;
        window.location.href = targetUrl.pathname + targetUrl.search + targetUrl.hash;
        return true;
      } catch (error) {
        return false;
      }
    }

    function goBack({ preferHistory = true } = {}) {
      if (preferHistory && canNavigateBackInApp()) {
        window.history.back();
        return;
      }
      if (goToReturnToPath()) {
        return;
      }
      const targetInstitutionId = returnInstitutionId || selectedInstitutionId;
      const suffix = targetInstitutionId ? "?institutionId=" + encodeURIComponent(targetInstitutionId) : "";
      window.location.href = "admin-dashboard.html" + suffix;
    }

    function renderProfile(user) {
      document.getElementById("userName").textContent = user?.name || "-";
      document.getElementById("userEmail").textContent = user?.email || "-";
      document.getElementById("userRole").textContent = formatRoleLabel(user?.role);
      document.getElementById("userStatus").textContent = user?.isActive ? "ACTIVE" : "INACTIVE";
      document.getElementById("userInstitution").textContent = user?.institution?.name || "-";
      document.getElementById("userLastLogin").textContent = formatDateTime(user?.lastLoginAt);

      const editBtn = document.getElementById("editBtn");
      if (!editBtn) return;
      if (canManageStaff && user?.id) {
        editBtn.classList.remove("hidden");
        const currentReturnTo = window.location.pathname + window.location.search;
        editBtn.href = buildStaffEditorUrl(user.id, selectedInstitutionId, returnInstitutionId || selectedInstitutionId, currentReturnTo);
      } else {
        editBtn.classList.add("hidden");
      }
    }

    function renderAssignedCourses(rows) {
      const tbody = document.getElementById("assignedCoursesTable");
      const hint = document.getElementById("assignedHint");
      const badge = document.getElementById("assignedCountBadge");
      if (!tbody || !hint || !badge) return;

      const list = Array.isArray(rows) ? rows : [];
      badge.textContent = list.length + " courses";

      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-3 py-2 border text-center text-gray-500">No assigned courses</td></tr>';
        hint.textContent = currentUser?.role === "teacher"
          ? "This teacher has no active assignments yet."
          : "Assigned courses are only shown for users with teacher role.";
        return;
      }

      hint.textContent = "Showing active assignments for this teacher.";
      tbody.innerHTML = list.map((assignment) => {
        const course = assignment?.course || {};
        return `
          <tr>
            <td class="px-3 py-2 border">${escapeHtml(course.program || "General")}</td>
            <td class="px-3 py-2 border">${escapeHtml(course.programVersion || "1")}</td>
            <td class="px-3 py-2 border">${escapeHtml(course.code || "-")}</td>
            <td class="px-3 py-2 border">${escapeHtml(course.name || "-")}</td>
            <td class="px-3 py-2 border">${escapeHtml(course.section || "-")}</td>
            <td class="px-3 py-2 border">${escapeHtml(formatCourseSchedule(course))}</td>
            <td class="px-3 py-2 border">${assignment?.isActive ? "ACTIVE" : "INACTIVE"}</td>
          </tr>
        `;
      }).join("");
    }

    async function loadUserProfile() {
      if (!userId) {
        setMessage("Missing userId.", "error");
        return null;
      }

      const response = await axios.get(API_BASE + "/api/auth/users/" + encodeURIComponent(userId), {
        params: { includeAll: isGlobalAdmin ? "true" : undefined }
      });
      const user = response?.data?.user || null;
      if (!user) {
        throw new Error("User not found");
      }

      currentUser = user;
      const institutionName = user?.institution?.name || "";
      applyInstitutionContext(user?.institutionId || selectedInstitutionId, institutionName);
      if (!returnInstitutionId) {
        returnInstitutionId = selectedInstitutionId;
      }
      renderProfile(user);
      return user;
    }

    async function loadTeacherAssignments(teacherId) {
      if (!teacherId) {
        renderAssignedCourses([]);
        return;
      }
      if (!selectedInstitutionId) {
        setMessage("Missing institution context for assignments.", "error");
        renderAssignedCourses([]);
        return;
      }

      const response = await axios.get(API_BASE + "/api/academic/assignments", {
        params: {
          teacherId,
          active: "true",
          page: 1,
          limit: 300
        }
      });
      const rows = response?.data?.data || [];
      renderAssignedCourses(rows);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const backBtn = document.getElementById("backBtn");
      if (backBtn) {
        backBtn.addEventListener("click", () => goBack({ preferHistory: true }));
      }

      try {
        const user = await loadUserProfile();
        if (!user) return;
        if (String(user.role || "").toLowerCase() === "teacher") {
          await loadTeacherAssignments(user.id);
        } else {
          renderAssignedCourses([]);
        }
      } catch (error) {
        setMessage(error.response?.data?.message || error.message || "Failed to load staff profile.", "error");
        renderAssignedCourses([]);
      }
    });
  </script>
</body>
</html>
